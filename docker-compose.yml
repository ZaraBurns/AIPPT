version: '3.8'

services:
  aippt:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: aippt-api
    ports:
      - "10828:10828"
    environment:
      # 从宿主机.env文件读取环境变量
      - DASHSCOPE_API_KEY=${DASHSCOPE_API_KEY}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - DEEPSEEK_API_KEY=${DEEPSEEK_API_KEY}
      - ZHIPU_API_KEY=${ZHIPU_API_KEY}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - UNSPLASH_ACCESS_KEY=${UNSPLASH_ACCESS_KEY}
      - PEXELS_API_KEY=${PEXELS_API_KEY}
      - DEFAULT_LLM_PROVIDER=${DEFAULT_LLM_PROVIDER:-qwen}
      - DEFAULT_LLM_MODEL=${DEFAULT_LLM_MODEL:-qwen-turbo}
      - DEFAULT_LLM_TEMPERATURE=${DEFAULT_LLM_TEMPERATURE:-0.7}
      - DEFAULT_LLM_MAX_TOKENS=${DEFAULT_LLM_MAX_TOKENS:-4000}
    volumes:
      # 挂载存储目录，数据持久化
      - ./storage:/app/storage
      # 挂载配置文件，支持热更新
      - ./config:/app/config
    restart: unless-stopped
    networks:
      - aippt-network
    healthcheck:
      test: ["CMD", "python", "-c", "import requests; requests.get('http://localhost:10828/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Nginx反向代理（可选）
  nginx:
    image: nginx:alpine
    container_name: aippt-nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - ./ssl:/etc/nginx/ssl:ro  # SSL证书（如果使用HTTPS）
    depends_on:
      - aippt
    restart: unless-stopped
    networks:
      - aippt-network
    profiles:
      - with-nginx

networks:
  aippt-network:
    driver: bridge

volumes:
  storage:
